{%extends 'main/base.html'%}

{%block content %}{% if not request.user.is_authenticated %}
<section>
    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Authentication Required</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Please login to access this feature.</p>
                </div>
                <div class="modal-body row">
                    <a href="{%url 'accounts:sign_in_view'%}" class="btn btn-danger col-4 mx-auto"
                        aria-disabled="true"><i class="bi bi-person-fill"></i></button>
                        sign in</a>
                </div>
            </div>
        </div>
    </div>
</section>

{%else%}

<section>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <h1>Event > #{{event.id}}</h1>
    <div class="card shadow event_info">

        <div class="d-flex flex-column mb-3">
            <p>{{event.event_organizer}}</p>
            <p>{{event.event_title}}</p>
            <p>{{event.event_date}}</p>
            <p>{{event.event_min_budget}}</p>
            <p>{{event.event_max_budget}}</p>
            <p>{{event.is_draw}}</p>
            <a href="{%url 'events:event_management_view'%}" class="btn btn-danger col-4 mx-auto"
                aria-disabled="true">manage the event</a>
        </div>
        <div id="app" class="container">
            <div class="row">
                <div class="col-md-12">

                    <div class="swiper-container">

                        <div class="swiper-wrapper timeline">
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    Preparation
                                    <span class="date">April 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Title</span>
                                </div>
                            </div>
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    <span class="date">May 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Second Title</span>
                                </div>
                            </div>
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    <span class="date">June 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Third Title</span>
                                </div>
                            </div>
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    <span class="date">July 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Fourth Title</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="copyMessage" class="alert alert-success" style="display: none; position: fixed; top: 20px; left: 50%; width: 90%; transform: translateX(-50%); z-index: 1050;">
        Link has been copied!
    </div>
    <h1>manage the event</h1>

    <div
        class="card shadow p-2 p-md-4 row row-cols-2 row-cols-sm-4 row-cols-md-6 d-flex flex-row justify-content-start align-items-start">
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none">
                <i class="bi bi-check-circle icons mb-3"></i>
                <h6>Validate the event and send email invitations</h6>
            </a>
        </div>

        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="{%url 'events:update_event_view' request.GET.event_id%}?prev={{request.path}}" class="text-dark text-decoration-none">
                <i class="bi bi-pencil-square icons"></i>
                <h6>Modify the event (date, description, etc.)</h6>
            </a>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none">
                <i class="bi bi-pencil-square icons"></i>
                <h6>Draw rules</h6>
            </a>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <button onclick="copyToClipboard()" class="text-dark text-decoration-none">
                <input type="text" id="shareableLink" value="{{ shareable_link }}" readonly class="form-control mb-2" style="visibility: hidden; height: 0; position: absolute;" />
                <i class="bi bi-share-fill icons"></i>
                <h6>Share registration link</h6>
            </button>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none">
                <i class="bi bi-sliders2 icons"></i>
                <h6>Manage options</h6>
            </a>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none">
                <i class="bi bi-palette-fill icons"></i>
                <h6>Customize the design</h6>
            </a>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none">
                <i class="bi bi-x-circle icons"></i>
                <h6>Cancel the Event</h6>
            </a>
        </div>

    </div>
    <h1>participant List</h1>

    <div class="table-responsive card shadow participants">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                <tr>
                    <td>{{ participant.user.username }}</td>
                    <td>{{ participant.user.email }}</td>
                    <td>
                        <i class="bi bi-check-circle"></i>
                    </td>
                </tr>
                {% endfor %}
                {% for participant in unconfirmed_participants %}
                <tr>
                    <td>{{ participant.name }}</td>
                    <td>{{ participant.email }}</td>
                    <td>
                        <button type="button" data-bs-toggle="modal" data-bs-target="#EditModal"
                            data-bs-whatever="{{ participant.id }}" data-bs-name="{{ participant.name }}"
                            data-bs-email="{{ participant.email }}" data-bs-event_id={{ request.GET.event_id }}><i class="bi bi-pencil-square"></i></button>
                        <i class="bi bi-x-circle"></i>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>


</section>

{% endif %}


<div class="modal fade" id="EditModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Changing the email </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="participantEmail" class="col-form-label">Email:</label>
                        <input type="email" class="form-control" id="participantEmail">
                        <input type="number" id="participantId">
                        <input type="number" id="eventId" >
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="updateParticipant()" class="btn btn-danger">Confirm Update </button>
            </div>
        </div>
    </div>
</div>

<script>
    const editModal = document.getElementById('EditModal')
    if (editModal) {
        editModal.addEventListener('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget
            // Extract info from data-bs-* attributes
            const participantId = button.getAttribute('data-bs-whatever'); // Get participant ID
            const participantName = button.getAttribute('data-bs-name'); // Get participant name
            const participantEmail = button.getAttribute('data-bs-email');
            const eventId = button.getAttribute('data-bs-event_id');
            
            // If necessary, you could initiate an Ajax request here
            // and then do the updating in a callback.


            // Update the modal's content.
            const modalTitle = editModal.querySelector('.modal-title')
            const emailInput = editModal.querySelector('#participantEmail');
            const idEventInput = editModal.querySelector('#eventId');
            const idInput = editModal.querySelector('#participantId');

            idInput.value=participantId
            idEventInput.value=eventId

            emailInput.value = participantEmail; // Set email in input field
            modalTitle.textContent = `Update the email of ${participantName}`

        })

        // Function to update participant (sends data to your Python function)
        function updateParticipant() {
            const currentPath = window.location.pathname;
            const queryString = window.location.search;
            console.log(currentPath+queryString)
            const id = document.getElementById('participantId').value;
            const event_id = document.getElementById('eventId').value;
            const email = document.getElementById('participantEmail').value;

            // Construct the new URL
            const newUrl = `${currentPath}${event_id}/update_participant`;
            // Make an AJAX call to the server to update the participant
            
            $.ajax({
                url: newUrl, // Your endpoint for updating the participant
                type: 'POST', // HTTP method
                data: {
                    id: id,
                    email: email,
                    csrfmiddlewaretoken: "{{ csrf_token }}"  

                },
                success: function (response) {
                    // Handle success - e.g., close the modal and refresh the participant list
                    console.log('Participant updated successfully:', response);
                    $('#EditModal').modal('hide');
                    // Refresh the current page
                    location.reload();
                    // Optionally, handle UI refresh if needed
                },
                error: function (xhr, status, error) {
                    console.error('Error updating participant:', error);
                    alert('There was an error updating the participant. Please try again.');
                }
            });
        }

    }
</script>
<script>
    function copyToClipboard() {
        // Get the hidden input field
        var copyLink = document.getElementById("shareableLink");

        // Use the Clipboard API (modern approach)
        navigator.clipboard.writeText(copyLink.value).then(function() {
            showCopyMessage("Link has been copied!");
        }, function(err) {
            showCopyMessage("Failed to copy the link.");
        });

        // Optional: Log message to console
        console.log("Attempted to copy the link.");
    }

    function showCopyMessage(message) {
        var alertDiv = document.getElementById("copyMessage");
        alertDiv.textContent = message; // Set the message text

        // Show the message
        alertDiv.style.display = "block"; 
        setTimeout(function() {
            alertDiv.style.display = "none"; // Hide the message after 3 seconds
        }, 3000);
    }
</script>
{% endblock%}