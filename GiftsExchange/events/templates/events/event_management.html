{%extends 'main/base.html'%}

{%block content %}{% if not request.user.is_authenticated %}
{%include 'accounts/auth_modal.html'%}

{%endif%}

{%if event.event_organizer.id != request.user.id%}
<section>
    <!-- Modal -->
    <div class="modal fade" id="unathorized" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Access Denied</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>You are trying to access an event that you do not own.</p>
                    <p>Only the event organizer has permission to view this page.</p>
                </div>
               
            </div>
        </div>
    </div>
</section>
{%else%}

<section>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <h1>My Event > #{{event.id}}</h1>
    <div class="card shadow event_info">

        <div class="d-flex flex-column mb-3">
            <p>{{event.event_organizer}}</p>
            <p>{{event.event_title}}</p>
            <p>{{event.event_date}}</p>
            <p>{{event.event_min_budget}}</p>
            <p>{{event.event_max_budget}}</p>

        
        </div>
        <div id="app" class="container">
            <div class="row">
                <div class="col-md-12">

                    <div class="swiper-container">

                        <div class="swiper-wrapper timeline">
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    Preparation
                                    <span class="date">April 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Title</span>
                                </div>
                            </div>
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    <span class="date">May 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Second Title</span>
                                </div>
                            </div>
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    <span class="date">June 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Third Title</span>
                                </div>
                            </div>
                            <div class="swiper-slide">
                                <div class="timestamp">
                                    <span class="date">July 2017<span>
                                </div>
                                <div class="status">
                                    <span>This is Fourth Title</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% if not event.is_draw %}
        <div class="container rounded bg-primary text-white my-3 py-2">
            <div class="row">
                <div class=" text-center">
                   <h2>
                    <i class="bi bi-exclamation-circle"></i>
                   </h2> 
                </div>
                <div class=" text-start">
                    <p>- Use the 'Validate Event' button when all participants have been added to send invitations</p>
                    <p>- Once the names are drawn, any unregistered participants will automatically be removed to prevent their names from being included in the draw.</p>                </div>
             
                 </div>
                 
        </div>
    {% endif %}
    </div>

    <div id="copyMessage" class="alert alert-success"
        style="display: none; position: fixed; top: 20px; left: 50%; width: 90%; transform: translateX(-50%); z-index: 1050;">
        Link has been copied!
    </div>
    <h1>manage the event</h1>

    <div class="card shadow p-2 p-md-4 row row-cols-5 row-cols-sm-7 row-cols-md-9 d-flex flex-row justify-content-start align-items-start">
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a  {% if not event.is_draw %} href="{%url 'events:validate_event_view' request.GET.event_id%}?prev={{request.path}}" {%else%} href="#" data-bs-toggle="modal" data-bs-target="#WarningModal " {%endif%} class="text-dark text-decoration-none">
                <i class="bi bi-check-circle icons mb-3"></i>
                <h6>Validate the event and send email invitations</h6>
            </a>
        </div>

        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="{%url 'events:update_event_view' request.GET.event_id%}?prev={{request.path}}"
                class="text-dark text-decoration-none">
                <i class="bi bi-pencil-square icons"></i>
                <h6>Modify the event (date, description, etc.)</h6>
            </a>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a  href="{%url 'events:draw_participants_view' request.GET.event_id%}?prev={{request.path}}" class="text-dark text-decoration-none">
                <i class="bi bi-pencil-square icons"></i>
                <h6>Draw Names</h6>
            </a>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <button onclick="copyToClipboard()" class="text-dark text-decoration-none">
                <input type="text" id="shareableLink" value="{{ shareable_link }}" readonly class="form-control mb-2"
                    style="visibility: hidden; height: 0; position: absolute;" />
                <i class="bi bi-share-fill icons"></i>
                <h6>Share registration link</h6>
            </button>
        </div>
        <!-- extra features -->
        <!-- <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none">
                <i class="bi bi-sliders2 icons"></i>
                <h6>Manage options</h6>
            </a>
        </div>
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none">
                <i class="bi bi-palette-fill icons"></i>
                <h6>Customize the design</h6>
            </a>
        </div> -->
        <div class="d-flex flex-column col justify-content-center align-items-center text-center">
            <a href="#" class="text-dark text-decoration-none" data-bs-toggle="modal" data-bs-target="#ConfirmationModal">
                <i class="bi bi-x-circle icons"></i>
                <h6>Cancel the Event</h6>
            </a>
        </div>

    </div>
    <h1>participant List</h1>

    <div class="table-responsive card shadow participants">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                <tr>
                    <td>{{ participant.user.username }}</td>
                    <td>{{ participant.user.email }}</td>
                    <td>
                        <i class="bi bi-check-circle"></i>
                    </td>
                </tr>
                {% endfor %}
                {% for participant in unconfirmed_participants %}
                <tr>
                    <td>{{ participant.name }}</td>
                    <td>{{ participant.email }}</td>
                    <td>
                        <button type="button" data-bs-toggle="modal" data-bs-target="#EditModal"
                            data-bs-whatever="{{ participant.id }}" data-bs-name="{{ participant.name }}"
                            data-bs-email="{{ participant.email }}" data-bs-event_id={{ request.GET.event_id }}><i
                                class="bi bi-pencil-square"></i></button>
                        <i class="bi bi-x-circle"></i>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>


</section>

{% endif %}
  <!-- Modal -->
  <div class="modal fade" id="ConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="ConfirmationModalLabel">Cancel Event</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to cancel {{event.event_title}} event?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <a href="{% url 'events:event_cancelation_view' event.id %}" class="btn btn-danger">Yes</a>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="ConfirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="ConfirmationModalLabel">Cancel Event</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to cancel {{event.event_title}} event?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <a href="{% url 'events:event_cancelation_view' event.id %}" class="btn btn-danger">Yes</a>
        </div>
      </div>
    </div>
  </div>
  <!-- warning modal -->
<div class="modal fade" id="WarningModal" tabindex="-1" aria-labelledby="WarningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="WarningModalLabel">Warning</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Sorry, the names for this event have already been drawn. 
                All registered participants have received an email, and unregistered participants have been removed.
                <br><br>
                If you wish to view the participants or get more information, please contact the event organizer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- email change modal -->
<div class="modal fade" id="EditModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Changing the email </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="participantEmail" class="col-form-label">Email:</label>
                        <input type="email" class="form-control" id="participantEmail">
                        <input type="number" id="participantId">
                        <input type="number" id="eventId">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="updateParticipant()" class="btn btn-danger">Confirm Update </button>
            </div>
        </div>
    </div>
</div>

<script>
    const editModal = document.getElementById('EditModal')
    if (editModal) {
        editModal.addEventListener('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget
            // Extract info from data-bs-* attributes
            const participantId = button.getAttribute('data-bs-whatever'); // Get participant ID
            const participantName = button.getAttribute('data-bs-name'); // Get participant name
            const participantEmail = button.getAttribute('data-bs-email');
            const eventId = button.getAttribute('data-bs-event_id');

            // If necessary, you could initiate an Ajax request here
            // and then do the updating in a callback.


            // Update the modal's content.
            const modalTitle = editModal.querySelector('.modal-title')
            const emailInput = editModal.querySelector('#participantEmail');
            const idEventInput = editModal.querySelector('#eventId');
            const idInput = editModal.querySelector('#participantId');

            idInput.value = participantId
            idEventInput.value = eventId

            emailInput.value = participantEmail; // Set email in input field
            modalTitle.textContent = `Update the email of ${participantName}`

        })

        // Function to update participant (sends data to your Python function)
        function updateParticipant() {
            const currentPath = window.location.pathname;
            const queryString = window.location.search;
            console.log(currentPath + queryString)
            const id = document.getElementById('participantId').value;
            const event_id = document.getElementById('eventId').value;
            const email = document.getElementById('participantEmail').value;

            // Construct the new URL
            const newUrl = `${currentPath}${event_id}/update_participant`;
            // Make an AJAX call to the server to update the participant

            $.ajax({
                url: newUrl, // Your endpoint for updating the participant
                type: 'POST', // HTTP method
                data: {
                    id: id,
                    email: email,
                    csrfmiddlewaretoken: "{{ csrf_token }}"

                },
                success: function (response) {
                    // Handle success - e.g., close the modal and refresh the participant list
                    console.log('Participant updated successfully:', response);
                    $('#EditModal').modal('hide');
                    // Refresh the current page
                    location.reload();
                    // Optionally, handle UI refresh if needed
                },
                error: function (xhr, status, error) {
                    console.error('Error updating participant:', error);
                    alert('There was an error updating the participant. Please try again.');
                }
            });
        }

    }
</script>

<script>
    function copyToClipboard() {
        // Get the hidden input field
        var copyLink = document.getElementById("shareableLink");

        // Use the Clipboard API (modern approach)
        navigator.clipboard.writeText(copyLink.value).then(function () {
            showCopyMessage("Link has been copied!");
        }, function (err) {
            showCopyMessage("Failed to copy the link.");
        });

        // Optional: Log message to console
        console.log("Attempted to copy the link.");
    }

    function showCopyMessage(message) {
        var alertDiv = document.getElementById("copyMessage");
        alertDiv.textContent = message; // Set the message text

        // Show the message
        alertDiv.style.display = "block";
        setTimeout(function () {
            alertDiv.style.display = "none"; // Hide the message after 3 seconds
        }, 3000);
    }
</script>
<script>
    // Automatically show the modal when the page loads if the user is not authenticated
    document.addEventListener('DOMContentLoaded', function () {
        var myModal = new bootstrap.Modal(document.getElementById('unathorized'), {
            backdrop: 'static',
            keyboard: false
        });
        myModal.show();
    });
</script>


{% endblock%}